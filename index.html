<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Kawaii é›²ç«¯è¨˜å¸³æœ¬</title>
    
    <!-- Firebase æ ¸å¿ƒ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #333; --bg: #f4f7f6; --card: #fff; }
        body { font-family: 'Nunito', 'Noto Sans TC', sans-serif; background: var(--bg); margin: 0; color: #333; -webkit-tap-highlight-color: transparent; padding-bottom: 50px;}

        /* UI å…ƒä»¶æ¨£å¼ */
        .btn { border: none; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; padding: 12px; font-size: 1rem; }
        .btn-danger { background: #ff7675; color: white; padding: 8px 15px; }
        .btn-google { background: white; color: #555; box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 12px 25px; font-size: 1rem; }

        /* é é¢åˆ‡æ› */
        #loginPage, #appPage { min-height: 100vh; }
        #loginPage { display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff; z-index: 100; position: fixed; top:0; left:0; width:100%;}
        #appPage { display: none; padding: 20px; max-width: 600px; margin: 0 auto; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }

        /* å¡ç‰‡èˆ‡è¼¸å…¥ */
        .card { background: var(--card); padding: 20px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        input:focus { outline: none; border-color: #888; background: #fff; }
        
        /* è‡ªå‹•åˆ†é¡ç‰¹æ•ˆ */
        .auto-highlight { animation: pulse 0.5s; border-color: #ff9a9e; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,154,158,0.7); } 70% { box-shadow: 0 0 0 10px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }

        /* çµ±è¨ˆ */
        .stats { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-box { flex: 1; background: #fff; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border-bottom: 3px solid #eee; }
        .stat-val { font-size: 1.2rem; font-weight: bold; margin-top: 5px; }
        .in-color { color: #00b894; border-color: #00b894; }
        .out-color { color: #d63031; border-color: #d63031; }

        /* åˆ—è¡¨ */
        .record-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f5f5f5; align-items: center; }
        .item-main { display: flex; flex-direction: column; }
        .item-cat { font-size: 0.75rem; background: #eee; padding: 2px 6px; border-radius: 4px; color: #666; width: fit-content; margin-top: 4px;}
        .price { font-weight: bold; font-size: 1.1rem; }
        
        /* å½ˆçª— Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: #fff; width: 90%; max-width: 450px; padding: 25px; border-radius: 20px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; }
        .close-icon { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #999; }
        
        /* æ­·å²å…¨è¢å¹• */
        #historyModal .modal-box { height: 85vh; display: flex; flex-direction: column; }
        #historyList { flex: 1; overflow-y: auto; margin-top: 10px; }
    </style>
</head>
<body>

<!-- 1. ç™»å…¥ç•«é¢ -->
<div id="loginPage">
    <div style="font-size:3rem; margin-bottom:10px;">ğŸ°</div>
    <h1 style="margin:0 0 30px 0;">Kawaii è¨˜å¸³æœ¬</h1>
    <button class="btn btn-google" onclick="login()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" style="margin-right:10px">
        ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
    </button>
</div>

<!-- 2. ä¸»ç¨‹å¼ç•«é¢ -->
<div id="appPage">
    <div class="header">
        <h2 style="margin:0">æˆ‘çš„éŒ¢åŒ…</h2>
        <img id="userAvatar" class="avatar" src="" onclick="logout()">
    </div>

    <!-- çµ±è¨ˆå€ -->
    <div class="stats">
        <div class="stat-box in-color">
            <small>æœ¬æœˆæ”¶å…¥</small>
            <div class="stat-val" id="monthIn">0</div>
        </div>
        <div class="stat-box out-color">
            <small>æœ¬æœˆæ”¯å‡º</small>
            <div class="stat-val" id="monthOut">0</div>
        </div>
    </div>

    <!-- è¨˜å¸³è¼¸å…¥å€ -->
    <div class="card">
        <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:10px;">
            <input type="date" id="dateInput">
            <select id="currencyInput">
                <option value="TWD">å°å¹£</option>
                <option value="USD">ç¾é‡‘</option>
                <option value="JPY">æ—¥åœ“</option>
                <option value="CNY">äººæ°‘å¹£</option>
            </select>
        </div>
        
        <input type="text" id="itemInput" placeholder="è¼¸å…¥é …ç›® (è‡ªå‹•åˆ†é¡)">
        <select id="categoryInput">
            <option value="é£²é£Ÿ">ğŸ± é£²é£Ÿ</option>
            <option value="äº¤é€š">ğŸš— äº¤é€š</option>
            <option value="è³¼ç‰©">ğŸ è³¼ç‰©</option>
            <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
            <option value="å±…ä½">ğŸ  å±…ä½</option>
            <option value="è–ªæ°´">ğŸ’° è–ªæ°´</option>
            <option value="å…¶ä»–">ğŸŒˆ å…¶ä»–</option>
        </select>

        <div style="display:flex; gap:10px;">
            <select id="typeInput" style="width: 100px;">
                <option value="expense">æ”¯å‡º</option>
                <option value="income">æ”¶å…¥</option>
            </select>
            <input type="number" id="amountInput" placeholder="é‡‘é¡" style="flex:1">
        </div>

        <button class="btn btn-primary" style="width:100%" onclick="addRecord()">âœ¨ è¨˜ä¸‹ä¸€ç­†</button>
    </div>

    <!-- è¿‘æœŸåˆ—è¡¨ -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin: 10px 5px;">
        <h3>è¿‘æœŸç´€éŒ„</h3>
        <button class="btn" style="background:#eee; padding:5px 10px; font-size:0.8rem;" onclick="openHistory()">æŸ¥çœ‹å…¨éƒ¨</button>
    </div>
    <div class="card" id="recentList" style="min-height:100px;">è¼‰å…¥ä¸­...</div>

</div>

<!-- 3. ç·¨è¼¯è¦–çª— -->
<div id="editModal" class="modal">
    <div class="modal-box">
        <span class="close-icon" onclick="closeModal('editModal')">Ã—</span>
        <h3>âœï¸ ç·¨è¼¯ç´€éŒ„</h3>
        <input type="hidden" id="editId">
        <input type="date" id="editDate">
        <input type="text" id="editItem">
        <select id="editCategory">
            <option value="é£²é£Ÿ">ğŸ± é£²é£Ÿ</option>
            <option value="äº¤é€š">ğŸš— äº¤é€š</option>
            <option value="è³¼ç‰©">ğŸ è³¼ç‰©</option>
            <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
            <option value="å±…ä½">ğŸ  å±…ä½</option>
            <option value="è–ªæ°´">ğŸ’° è–ªæ°´</option>
            <option value="å…¶ä»–">ğŸŒˆ å…¶ä»–</option>
        </select>
        <div style="display:flex; gap:10px;">
             <select id="editCurrency" style="width:80px">
                <option value="TWD">å°å¹£</option>
                <option value="USD">ç¾é‡‘</option>
                <option value="JPY">æ—¥åœ“</option>
            </select>
            <input type="number" id="editAmount">
        </div>
        
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-danger" onclick="deleteFromEdit()">åˆªé™¤</button>
            <button class="btn btn-primary" style="flex:1" onclick="saveEdit()">å„²å­˜</button>
        </div>
    </div>
</div>

<!-- 4. æ­·å²ç´€éŒ„è¦–çª— -->
<div id="historyModal" class="modal">
    <div class="modal-box">
        <span class="close-icon" onclick="closeModal('historyModal')">Ã—</span>
        <h3>ğŸ“œ æ‰€æœ‰ç´€éŒ„</h3>
        <input type="text" id="searchHistory" placeholder="ğŸ” æœå°‹é …ç›®æˆ–æ—¥æœŸ..." oninput="filterHistory()">
        <div id="historyList"></div>
    </div>
</div>

<script>
    // âš ï¸âš ï¸âš ï¸ ç¬¬ 3 æ­¥ï¼šè«‹å°‡ä½ åœ¨ Firebase è¤‡è£½çš„è¨­å®šè²¼åœ¨ä¸‹æ–¹ âš ï¸âš ï¸âš ï¸
    const firebaseConfig = {
        // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDT_5fDqMEKU7fsGJdnJh3ABocxGYU0qrs",
  authDomain: "keepaccounting.firebaseapp.com",
  projectId: "keepaccounting",
  storageBucket: "keepaccounting.firebasestorage.app",
  messagingSenderId: "689155194970",
  appId: "1:689155194970:web:92b5fc042188578fed5863",
  measurementId: "G-X1VKGS5RQG"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
    };
    // âš ï¸âš ï¸âš ï¸ è¨­å®šçµæŸ âš ï¸âš ï¸âš ï¸

    // åˆå§‹åŒ–
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;
    let unsubscribe = null;
    let allRecords = []; // æœ¬åœ°æš«å­˜æ‰€æœ‰ç´€éŒ„ (æœå°‹ç”¨)
    
    // é—œéµå­—è¨­å®š
    const keywords = {
        'é£²é£Ÿ': ['é£¯','éºµ','åƒ','å–','é¤','èŒ¶','å’–å•¡','éº¥ç•¶å‹','è‚¯å¾·åŸº','é£²æ–™'],
        'äº¤é€š': ['è»Š','æ·é‹','æ²¹','é«˜éµ','æ‚ éŠå¡','uber'],
        'è³¼ç‰©': ['è²·','è¡£','é‹','åŒ…','è¡›ç”Ÿç´™','è¦çš®'],
        'å¨›æ¨‚': ['ç©','æˆ²','å½±','éŠæˆ²','switch','netflix'],
        'å±…ä½': ['æˆ¿ç§Ÿ','é›»','æ°´','ç“¦æ–¯','ç¶²è·¯'],
        'è–ªæ°´': ['è–ª','çé‡‘']
    };

    // 1. ç›£è½ç™»å…¥ç‹€æ…‹
    auth.onAuthStateChanged(user => {
        if(user) {
            currentUser = user;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appPage').style.display = 'block';
            document.getElementById('userAvatar').src = user.photoURL;
            document.getElementById('dateInput').valueAsDate = new Date();
            loadData(); // å•Ÿå‹•è³‡æ–™ç›£è½
        } else {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('appPage').style.display = 'none';
        }
    });

function login() { 
    // åŠ å…¥ catch ä¾†æ•æ‰éŒ¯èª¤ä¸¦é¡¯ç¤ºå‡ºä¾†
    auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider())
        .catch(function(error) {
            alert("éŒ¯èª¤ä»£ç¢¼: " + error.code + "\néŒ¯èª¤è¨Šæ¯: " + error.message);
        });
}
    function logout() { if(confirm("ç™»å‡ºï¼Ÿ")) auth.signOut(); }

    // 2. è³‡æ–™åº«å³æ™‚ç›£è½ (æ ¸å¿ƒåŠŸèƒ½)
    function loadData() {
        if(unsubscribe) unsubscribe();
        // æŠ“å–è©²ç”¨æˆ¶æ‰€æœ‰è³‡æ–™
        unsubscribe = db.collection('records')
            .where('uid', '==', currentUser.uid)
            .orderBy('date', 'desc')
            .orderBy('createdAt', 'desc')
            .onSnapshot(snapshot => {
                allRecords = [];
                let mIn = 0, mOut = 0;
                const now = new Date(); 
                const thisMonth = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');

                // è™•ç†è³‡æ–™
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id; // ç¶å®š ID æ–¹ä¾¿ä¹‹å¾Œç·¨è¼¯
                    allRecords.push(data);

                    // ç°¡æ˜“çµ±è¨ˆæœ¬æœˆ (ä¸æ›ç®—åŒ¯ç‡ï¼Œç›´æ¥åŠ ç¸½è©²æ•¸å­—ï¼Œå¯ä¾éœ€æ±‚ä¿®æ”¹)
                    if(data.date.startsWith(thisMonth)) {
                        if(data.type === 'income') mIn += data.amount;
                        else mOut += data.amount;
                    }
                });

                // æ›´æ–° UI
                document.getElementById('monthIn').innerText = mIn.toLocaleString();
                document.getElementById('monthOut').innerText = mOut.toLocaleString();
                renderList(allRecords.slice(0, 20), 'recentList'); // é¦–é åªé¡¯ç¤ºæœ€æ–°çš„ 20 ç­†
                
                // å¦‚æœæ­·å²è¦–çª—é–‹è‘—ï¼Œä¹Ÿè¦æ›´æ–°
                if(document.getElementById('historyModal').style.display === 'flex') {
                    filterHistory();
                }
            });
    }

    // 3. æ¸²æŸ“åˆ—è¡¨ (å…±ç”¨å‡½æ•¸)
    function renderList(dataArray, elementId) {
        const container = document.getElementById(elementId);
        container.innerHTML = '';
        if(dataArray.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#999;padding:10px">æš«ç„¡è³‡æ–™</div>';
            return;
        }

        dataArray.forEach(item => {
            const div = document.createElement('div');
            div.className = 'record-item';
            div.onclick = () => openEdit(item); // é»æ“Šç·¨è¼¯
            div.innerHTML = `
                <div class="item-main">
                    <span style="font-weight:bold">${item.item}</span>
                    <span style="font-size:0.8rem; color:#999">${item.date}</span>
                    <span class="item-cat">${item.category}</span>
                </div>
                <div class="price ${item.type==='income'?'in-color':'out-color'}">
                    ${item.type==='income'?'+':'-'} ${item.currency} ${item.amount}
                </div>
            `;
            container.appendChild(div);
        });
    }

    // 4. æ–°å¢è³‡æ–™
    function addRecord() {
        const date = document.getElementById('dateInput').value;
        const item = document.getElementById('itemInput').value;
        const cat = document.getElementById('categoryInput').value;
        const curr = document.getElementById('currencyInput').value;
        const amt = parseFloat(document.getElementById('amountInput').value);
        const type = document.getElementById('typeInput').value;

        if(!item || isNaN(amt)) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

        db.collection('records').add({
            uid: currentUser.uid,
            date: date, item: item, category: cat, currency: curr, amount: amt, type: type,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            document.getElementById('itemInput').value = '';
            document.getElementById('amountInput').value = '';
        });
    }

    // 5. ç·¨è¼¯èˆ‡åˆªé™¤
    function openEdit(item) {
        document.getElementById('editId').value = item.id;
        document.getElementById('editDate').value = item.date;
        document.getElementById('editItem').value = item.item;
        document.getElementById('editCategory').value = item.category;
        document.getElementById('editCurrency').value = item.currency;
        document.getElementById('editAmount').value = item.amount;
        document.getElementById('editModal').style.display = 'flex';
    }

    function saveEdit() {
        const id = document.getElementById('editId').value;
        db.collection('records').doc(id).update({
            date: document.getElementById('editDate').value,
            item: document.getElementById('editItem').value,
            category: document.getElementById('editCategory').value,
            currency: document.getElementById('editCurrency').value,
            amount: parseFloat(document.getElementById('editAmount').value)
        }).then(() => closeModal('editModal'));
    }

    function deleteFromEdit() {
        if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
            db.collection('records').doc(document.getElementById('editId').value).delete();
            closeModal('editModal');
        }
    }

    // 6. æ­·å²æœå°‹èˆ‡ Modal æ§åˆ¶
    function openHistory() {
        document.getElementById('historyModal').style.display = 'flex';
        filterHistory();
    }
    
    function filterHistory() {
        const text = document.getElementById('searchHistory').value.toLowerCase();
        const filtered = allRecords.filter(r => r.item.toLowerCase().includes(text) || r.date.includes(text) || r.category.includes(text));
        renderList(filtered, 'historyList');
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // è‡ªå‹•åˆ†é¡
    document.getElementById('itemInput').addEventListener('input', function(e){
        const val = e.target.value.toLowerCase();
        const catSelect = document.getElementById('categoryInput');
        for(const [cat, kws] of Object.entries(keywords)){
            if(kws.some(k => val.includes(k))){
                if(catSelect.value !== cat) {
                    catSelect.value = cat;
                    catSelect.classList.remove('auto-highlight');
                    void catSelect.offsetWidth;
                    catSelect.classList.add('auto-highlight');
                }
                break;
            }
        }
    });
</script>
</body>
</html>
